#!/usr/bin/env groovy

def packageType = "Source Package"
def STAGES_DIR = "pipeline/stages/"
def trace

try {
  node('master') {
    checkout scm

    echo "######### packageType==" + packageType + " ###############"

    // Load tracing definition file
    trace = load 'pipeline/pipelineTrace.groovy'
    trace.location = WORKSPACE
    trace.buildNumber = "${env.BUILD_NUMBER}"
    trace.gitBranch = "${env.GIT_BRANCH}"
    trace.startStage('Pipeline')

    // Execute Appropriate Stages
    def build = load STAGES_DIR + "_MS_Build_Stage"
    build.packageType = packageType
    build.trace = trace
    build.execute()
  
    def coverage = load STAGES_DIR + "_MS_Coverage_Stage"
    coverage.trace = trace
    coverage.execute()

    def upload = load STAGES_DIR + "_MS_ArtifactUpload_Stage"
    upload.trace = trace
    upload.execute()

    def analysis = load STAGES_DIR + "_MS_Code_Analysis"
    analysis.trace = trace
    analysis.execute()

    def deployToDev = load STAGES_DIR + "_MS_DeployToDev_Stage"
    deployToDev.trace = trace
    deployToDev.execute()

    def deployToTest = load STAGES_DIR + "_MS_DeployToTest_Stage"
    deployToTest.trace = trace
    deployToTest.execute()

    trace.endStage('Pipeline')
  }
}
catch (exc) {
  echo "Caught: ${exc}"
}
